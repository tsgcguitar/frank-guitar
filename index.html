<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frank Guitar ç·šä¸Šå‰ä»–æ•™å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* ç¯€æ‹å™¨å‹•ç•« */
        .beat-dot { width: 12px; height: 12px; border-radius: 50%; background: #ccc; transition: background 0.1s; }
        .beat-active { background: #ef4444; box-shadow: 0 0 10px #ef4444; transform: scale(1.2); }
        
        /* å’Œå¼¦åœ–æ¨£å¼ */
        .fretboard { width: 140px; height: 160px; border: 1px solid #333; position: relative; background: #fff; margin: 0 auto; user-select: none; }
        .string { position: absolute; height: 100%; width: 1px; background: #888; top: 0; }
        .fret { position: absolute; width: 100%; height: 1px; background: #888; left: 0; }
        .nut { position: absolute; width: 100%; height: 6px; background: #333; top: -6px; left: 0; }
        
        /* å’Œå¼¦é»é» */
        .dot { 
            position: absolute; width: 20px; height: 20px; border-radius: 50%; 
            transform: translate(-50%, -50%); z-index: 10; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: white; font-weight: bold; cursor: pointer;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .dot:active { transform: translate(-50%, -50%) scale(0.9); }
        .dot-normal { background: #333; }
        .dot-root { background: #ef4444; border: 2px solid #991b1b; } /* æ ¹éŸ³ç‚ºç´…è‰² */
        
        /* ç·¨è¼¯æ¨¡å¼ä¸‹çš„äº’å‹•æ„Ÿæ‡‰å€ */
        .fret-cell { position: absolute; z-index: 5; cursor: crosshair; }
        .fret-cell:hover { background-color: rgba(255, 200, 0, 0.2); }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col" v-cloak>

    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div v-if="!user.isLoggedIn" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1510915361894-db8b60106cb1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80')] bg-cover bg-center bg-no-repeat">
        <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-96 backdrop-blur-sm">
            <div class="text-center mb-6">
                <img :src="settings.logoUrl" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2907/2907253.png'" class="h-20 mx-auto mb-2 object-contain">
                <h2 class="text-2xl font-bold text-gray-800 tracking-wider">FRANK GUITAR</h2>
                <p class="text-gray-500 text-sm">å°ˆæ¥­å‰ä»–æ•™å­¸ç³»çµ±</p>
            </div>
            <div class="space-y-4">
                <input type="text" v-model="loginForm.username" class="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none transition" placeholder="å¸³è™Ÿ">
                <input type="password" v-model="loginForm.password" @keyup.enter="handleLogin" class="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none transition" placeholder="å¯†ç¢¼">
                <button @click="handleLogin" class="w-full bg-yellow-600 text-white p-3 rounded-lg hover:bg-yellow-700 transition font-bold shadow-lg transform hover:-translate-y-1">é€²å…¥æ•™å®¤</button>
            </div>
            <p class="text-xs text-center text-gray-400 mt-4">é è¨­: admin / 1234 (è€å¸«), student / 1234 (å­¸ç”Ÿ)</p>
        </div>
    </div>

    <!-- 2. ä¸»ç•«é¢ -->
    <div v-else class="flex h-full">
        <!-- å·¦å´é¸å–® -->
        <aside class="w-80 bg-white shadow-xl flex flex-col z-10 border-r flex-shrink-0">
            <div class="p-5 bg-gray-900 text-white flex items-center gap-3">
                <img :src="settings.logoUrl" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2907/2907253.png'" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
                <div>
                    <h1 class="font-bold text-lg tracking-wide">FRANK GUITAR</h1>
                    <span class="text-xs text-yellow-400 bg-gray-800 px-2 py-0.5 rounded border border-yellow-600">
                        {{ user.role === 'teacher' ? 'ğŸ‘¨â€ğŸ« è€å¸«ç«¯' : 'ğŸ‘¨â€ğŸ“ å­¸ç”Ÿç«¯' }}
                    </span>
                </div>
            </div>

            <!-- Gamification -->
            <div class="p-4 bg-gradient-to-r from-gray-800 to-gray-700 text-white border-b border-gray-600">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <div class="text-xs text-gray-300">ç›®å‰ç­‰ç´š</div>
                        <div class="text-2xl font-bold text-yellow-400">Lv. {{ userLevel.level }}</div>
                    </div>
                    <div class="text-xs text-right text-gray-300">XP: {{ user.xp }} / {{ userLevel.nextLevelXp }}</div>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-2.5 mb-3">
                    <div class="bg-yellow-500 h-2.5 rounded-full transition-all duration-500" :style="{ width: userLevel.progress + '%' }"></div>
                </div>
                <div class="flex justify-between gap-1 overflow-x-auto scrollbar-hide py-1">
                    <div v-for="badge in badges" :key="badge.id" :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs border-2 tooltip-container cursor-help transition', user.badges.includes(badge.id) ? 'bg-yellow-100 border-yellow-500 text-yellow-700' : 'bg-gray-600 border-gray-500 text-gray-400 grayscale opacity-50']" :title="badge.desc">
                        <i :class="badge.icon"></i>
                    </div>
                </div>
            </div>
            
            <!-- èª²ç¨‹åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto scrollbar-hide bg-gray-50">
                <div v-for="(lesson, index) in lessons" :key="index" 
                     @click="selectLesson(index)"
                     :class="['p-3 border-b cursor-pointer transition hover:bg-white text-sm relative group', currentLessonIndex === index ? 'bg-yellow-50 border-l-4 border-yellow-600' : 'border-l-4 border-transparent']">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-gray-500 text-xs">Week {{ index + 1 }}</span>
                        <div class="flex gap-1">
                            <i v-if="lesson.videoUrl" class="fa-solid fa-video text-gray-300 text-xs"></i>
                            <i v-if="lesson.homework && lesson.homework.hasSubmission" class="fa-solid fa-check-circle text-green-500 text-xs" title="ä½œæ¥­å·²ç¹³"></i>
                        </div>
                    </div>
                    <div class="text-gray-800 font-medium truncate group-hover:text-yellow-700 transition">{{ lesson.title }}</div>
                </div>
            </div>

            <div class="bg-white border-t p-3 space-y-2">
                <div class="flex gap-2">
                    <a href="https://frankguitar2.webnode.tw/" target="_blank" class="flex-1 text-center py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs text-gray-700 font-bold transition"><i class="fa-solid fa-globe mr-1"></i> å®˜ç¶²</a>
                    <a href="https://www.instagram.com/isabella_workroom?igsh=a2RiNDE3YTg1dGNz&utm_source=qr" target="_blank" class="flex-1 text-center py-2 bg-pink-50 hover:bg-pink-100 rounded text-xs text-pink-600 font-bold transition"><i class="fa-brands fa-instagram mr-1"></i> IG</a>
                </div>
                <button @click="logout" class="w-full text-center text-xs text-gray-400 hover:text-red-500 mt-1">ç™»å‡º</button>
            </div>
        </aside>

        <!-- å³å´å…§å®¹å€ -->
        <main class="flex-1 overflow-y-auto bg-gray-100 relative">
            
            <!-- æ‡¸æµ®å·¥å…· -->
            <div class="fixed top-4 right-4 z-40 flex gap-2">
                <button @click="showChordModal = true" class="bg-white p-3 rounded-full shadow-lg text-gray-700 hover:text-yellow-600 hover:scale-110 transition" title="å’Œå¼¦æŸ¥è©¢"><i class="fa-solid fa-music"></i></button>
                <button @click="showMetronome = !showMetronome" :class="['p-3 rounded-full shadow-lg transition hover:scale-110', showMetronome ? 'bg-yellow-500 text-white' : 'bg-white text-gray-700 hover:text-yellow-600']" title="ç¯€æ‹å™¨"><i class="fa-solid fa-clock"></i></button>
            </div>

            <!-- ç¯€æ‹å™¨é¢æ¿ -->
            <div v-if="showMetronome" class="fixed top-20 right-4 z-30 bg-gray-800 p-5 rounded-xl shadow-2xl text-white w-64 border border-gray-700">
                <h3 class="font-bold text-yellow-500 mb-3"><i class="fa-solid fa-stopwatch"></i> ç¯€æ‹å™¨</h3>
                <div class="flex justify-between items-center mb-4">
                    <button @click="adjustBpm(-5)" class="w-8 h-8 bg-gray-700 rounded hover:bg-gray-600">-</button>
                    <div class="text-3xl font-mono font-bold">{{ metronome.bpm }}</div>
                    <button @click="adjustBpm(5)" class="w-8 h-8 bg-gray-700 rounded hover:bg-gray-600">+</button>
                </div>
                <button @click="toggleMetronome" :class="['w-full py-2 rounded font-bold transition', metronome.isPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700']">{{ metronome.isPlaying ? 'åœæ­¢' : 'é–‹å§‹' }}</button>
            </div>

            <!-- â˜…â˜…â˜… å’Œå¼¦æŸ¥è©¢èˆ‡ç·¨è¼¯å™¨ Modal â˜…â˜…â˜… -->
            <div v-if="showChordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" @click.self="showChordModal = false">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md m-4 relative">
                    <!-- æ¨™é¡Œèˆ‡é—œé–‰ -->
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-xl text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-music text-yellow-500"></i> å’Œå¼¦å­—å…¸
                            <span v-if="isEditingChord" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ç·¨è¼¯æ¨¡å¼</span>
                        </h3>
                        <div>
                            <!-- è€å¸«æ‰çœ‹å¾—åˆ°çš„ç·¨è¼¯æŒ‰éˆ• -->
                            <button v-if="user.role === 'teacher'" @click="toggleChordEdit" :class="['text-xs px-3 py-1 rounded mr-2 transition', isEditingChord ? 'bg-green-500 text-white' : 'bg-gray-200 hover:bg-gray-300']">
                                <i :class="isEditingChord ? 'fa-solid fa-save' : 'fa-solid fa-pen'"></i> {{ isEditingChord ? 'å„²å­˜è¨­å®š' : 'ç·¨è¼¯' }}
                            </button>
                            <button @click="showChordModal = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>

                    <!-- é¸æ“‡å™¨ -->
                    <div class="flex gap-2 mb-6">
                        <select v-model="chord.root" class="flex-1 p-2 border rounded bg-gray-50 font-bold text-center text-lg"><option v-for="r in chordRoots" :value="r">{{r}}</option></select>
                        <select v-model="chord.suffix" class="flex-1 p-2 border rounded bg-gray-50 text-center text-lg"><option v-for="s in chordSuffixes" :value="s.val">{{s.name}}</option></select>
                    </div>

                    <!-- æŒ‡æ¿é¡¯ç¤ºå€ -->
                    <div class="flex flex-col items-center select-none">
                        <h2 class="text-4xl font-bold text-yellow-600 mb-4">{{ chord.root }}{{ chord.suffix }}</h2>
                        
                        <!-- äº’å‹•å¼æŒ‡æ¿ -->
                        <div class="fretboard shadow-inner relative">
                            <!-- å¼¦èˆ‡ç´è¡ (è¦–è¦ºå±¤) -->
                            <div v-for="i in 6" :style="{left: (i-1)*24 + 10 + 'px'}" class="string"></div>
                            <div v-for="i in 5" :style="{top: (i-1)*32 + 'px'}" class="fret"></div>
                            <div class="nut"></div>

                            <!-- ç·¨è¼¯æ¨¡å¼ä¸‹çš„æ„Ÿæ‡‰ç¶²æ ¼ (é»æ“Šå±¤) -->
                            <div v-if="isEditingChord">
                                <template v-for="s in 6">
                                    <div v-for="f in 5" 
                                         class="fret-cell" 
                                         :style="{left: (s-1)*24 + 'px', top: (f-1)*32 + 'px', width: '24px', height: '32px'}"
                                         @click.left="handleFretClick(7-s, f)"
                                         @contextmenu.prevent="handleFretRightClick(7-s, f)"
                                         title="å·¦éµ:æ–°å¢/æ›æŒ‡ | å³éµ:è¨­ç‚ºæ ¹éŸ³">
                                    </div>
                                </template>
                            </div>

                            <!-- å’Œå¼¦é»é» (é¡¯ç¤ºå±¤) -->
                            <div v-for="dot in currentChordDots" 
                                 :class="['dot', dot.isRoot ? 'dot-root' : 'dot-normal']"
                                 :style="{left: (7-dot.s-1)*24 + 10 + 'px', top: (dot.f * 32) - 16 + 'px'}"
                                 @click.stop="isEditingChord ? handleFretClick(dot.s, dot.f) : null"
                                 @contextmenu.prevent.stop="isEditingChord ? handleFretRightClick(dot.s, dot.f) : null">
                                {{ dot.finger }}
                            </div>
                        </div>

                        <!-- ç·¨è¼¯èªªæ˜ -->
                        <div v-if="isEditingChord" class="mt-4 text-xs text-gray-500 bg-gray-100 p-2 rounded w-full text-center">
                            <p><i class="fa-solid fa-computer-mouse"></i> <b>å·¦éµé»æ“Š</b>ï¼šæ–°å¢æŒ‰æ³• / åˆ‡æ›æŒ‡æ³•(1-4) / ç§»é™¤</p>
                            <p><i class="fa-solid fa-flag"></i> <b>å³éµé»æ“Š</b>ï¼šè¨­ç‚º <span class="text-red-500 font-bold">æ ¹éŸ³ (ç´…è‰²)</span></p>
                        </div>
                        <div v-else class="text-sm text-gray-400 mt-4">æŒ‡æ¿ä¸Šæ–¹ç‚ºç¬¬ 1 æ ¼ (Nut)</div>
                    </div>
                </div>
            </div>

            <!-- èª²ç¨‹å…§å®¹ (åŒ V8, çœç•¥éƒ¨åˆ†é‡è¤‡ä»£ç¢¼ä»¥ç¯€çœç¯‡å¹…, åŠŸèƒ½å®Œå…¨ä¿ç•™) -->
            <div class="max-w-5xl mx-auto p-6 min-h-screen pb-32">
                <div v-if="currentLesson">
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border-l-4 border-yellow-500">
                        <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">Week {{ currentLessonIndex + 1 }}</span>
                        <h2 class="text-3xl font-bold mt-2 text-gray-800">{{ currentLesson.title }}</h2>
                        <p class="mt-2 text-gray-600">{{ currentLesson.desc }}</p>
                        <div v-if="user.role === 'teacher'" class="mt-4 p-2 bg-blue-50 text-blue-700 text-xs rounded border border-blue-100">
                            <i class="fa-solid fa-info-circle"></i> æç¤ºï¼šä¿®æ”¹èª²ç¨‹æ¨™é¡Œ/é€£çµè«‹ç·¨è¼¯ index.htmlã€‚
                        </div>
                    </div>
                    <!-- å½±ç‰‡ -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-red-500 pl-2">æ•™å­¸å½±ç‰‡</h3>
                        <div v-if="getEmbedUrl(currentLesson.videoUrl)">
                            <div class="video-container rounded-lg bg-black">
                                <iframe :src="getEmbedUrl(currentLesson.videoUrl)" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>
                        <div v-else class="h-64 bg-gray-200 rounded-lg flex flex-col items-center justify-center text-gray-500"><i class="fa-brands fa-youtube text-4xl mb-2"></i><p>æœ¬é€±ç„¡å½±ç‰‡é€£çµ</p></div>
                    </div>
                    <!-- è¬›ç¾© -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-green-500 pl-2">è¬›ç¾©è³‡æº</h3>
                        <div v-if="currentLesson.handoutUrl">
                            <div v-if="isImage(currentLesson.handoutUrl)">
                                <img :src="currentLesson.handoutUrl" class="w-full h-auto rounded border mb-2 cursor-pointer shadow" onclick="window.open(this.src)">
                            </div>
                            <div v-else class="text-center py-8">
                                <a :href="currentLesson.handoutUrl" target="_blank" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 shadow"><i class="fa-solid fa-download"></i> é–‹å•Ÿè¬›ç¾©</a>
                            </div>
                        </div>
                        <div v-else class="text-center py-10 bg-gray-50 border border-dashed rounded"><p class="text-gray-400 text-sm">ç„¡è¬›ç¾©</p></div>
                    </div>
                    <!-- ä½œæ¥­ (æœ¬åœ°) -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border-2 border-orange-100">
                        <div class="flex justify-between items-center mb-4 border-l-4 border-orange-500 pl-2">
                            <h3 class="font-bold text-gray-700">æœ¬é€±ä½œæ¥­</h3>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold">+50 XP</span>
                        </div>
                        <div v-if="!currentLesson.homework.hasSubmission">
                            <div v-if="user.role === 'student'">
                                <div class="bg-orange-50 p-4 rounded mb-4">
                                    <input v-model="tempHomework.link" class="w-full border p-2 rounded mb-2 text-sm" placeholder="é€£çµ...">
                                    <textarea v-model="tempHomework.note" class="w-full border p-2 rounded text-sm" placeholder="å¿ƒå¾—..."></textarea>
                                </div>
                                <button @click="submitHomework" class="bg-orange-500 text-white px-6 py-2 rounded font-bold hover:bg-orange-600 shadow">æäº¤</button>
                            </div>
                            <div v-else class="text-gray-500 text-center py-4 bg-gray-50 rounded">å°šæœªç¹³äº¤</div>
                        </div>
                        <div v-else class="bg-gray-50 p-4 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <span class="bg-green-600 text-white text-xs px-2 py-1 rounded">å·²ç¹³äº¤</span>
                                <span class="text-xs text-gray-500">{{ currentLesson.homework.date }}</span>
                            </div>
                            <p class="font-bold text-gray-800"><a :href="currentLesson.homework.link" target="_blank" class="text-blue-600 underline">ä½œæ¥­é€£çµ</a></p>
                            <p class="text-gray-600 mt-2 text-sm bg-white p-2 rounded border">"{{ currentLesson.homework.note }}"</p>
                            <div v-if="user.role === 'teacher'" class="mt-4 border-t pt-4">
                                <input v-model="currentLesson.homework.teacherGrade" class="border p-1 rounded w-20 mb-2 text-sm" placeholder="åˆ†æ•¸">
                                <button @click="saveHomeworkGrade" class="bg-blue-600 text-white px-4 py-1 rounded text-sm">è©•åˆ†</button>
                            </div>
                            <div v-if="user.role === 'student' && currentLesson.homework.isGraded" class="mt-4 border-t pt-4 bg-blue-50 p-3 rounded">
                                <div class="text-2xl font-bold text-red-500">{{ currentLesson.homework.teacherGrade }} åˆ†</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const { createApp } = Vue;

    const BADGES = [
        { id: 'novice', name: 'å‰ä»–æ–°æ˜Ÿ', desc: 'å®Œæˆ 5 å ‚èª²ç¨‹', icon: 'fa-solid fa-star' },
        { id: 'homework_king', name: 'ç·´ç¿’ç‹‚äºº', desc: 'ç¹³äº¤ 5 æ¬¡ä½œæ¥­', icon: 'fa-solid fa-pen-nib' },
        { id: 'halfway', name: 'ä¸­ç´šæ¨‚æ‰‹', desc: 'å®Œæˆ 30 å ‚èª²ç¨‹', icon: 'fa-solid fa-medal' },
        { id: 'master', name: 'æŒ‡å½ˆå¤§å¸«', desc: 'å®Œæˆ 60 å ‚èª²ç¨‹', icon: 'fa-solid fa-crown' }
    ];

    const lessonsData = [
        { title: "èªè­˜å‰ä»–ï¼Œçˆ¬æ ¼å­ï¼Œèª¿éŸ³æ–¹å¼ï¼ŒéŸ³éšç·´ç¿’", desc: "é€™æ˜¯å‰ä»–æ—…ç¨‹çš„èµ·é»ã€‚", videoUrl: "https://youtu.be/zZFLh6e_WIs?si=4sBiSU1sS1qw1xQi", handoutUrl: "" },
        { title: "å­¸ç¿’çœ‹å…­ç·šè­œï¼Œå°èœœèœ‚å–®éŸ³", desc: "å­¸æœƒé–±è®€å‰ä»–å°ˆç”¨çš„æ¨‚è­œã€‚", videoUrl: "https://youtu.be/L5MxxZ3Qk2o?si=ORgiGiAYfp9Ix9aS", handoutUrl: "" },
        { title: "å’Œå¼¦ç·´ç¿’ï¼ŒC G7 å°èœœèœ‚å’Œå¼¦", desc: "ç¬¬ä¸€æ¬¡åˆ·å‡ºå’Œè²ã€‚", videoUrl: "https://youtu.be/sRBbHiRuO2w?si=R8WpQSF6dwh0KuJn", handoutUrl: "" },
        { title: "å’Œå¼¦è¡¨1 å¯¶è²", desc: "å¼µæ‡¸ç¶“å…¸æ­Œæ›²å¯¦æˆ°ã€‚", videoUrl: "https://youtu.be/IBDuz3hyfUA?si=KdqswqRrn297PPVe", handoutUrl: "" },
        { title: "å¯¶è²æŒ‡æ³•ç‰ˆ æ…¢éˆé­‚æŒ‡æ³•", desc: "å¾åˆ·æ³•è½‰ç‚ºç´°è†©çš„æŒ‡æ³•ã€‚", videoUrl: "https://youtu.be/niffuL6lpAE?si=egmVLpFDrf9eIGSo", handoutUrl: "" },
        { title: "æ“æŠ±æ­Œæ›²", desc: "äº”æœˆå¤©å…¥é–€å¿…å­¸ã€‚", videoUrl: "https://youtu.be/XgB9p6I1ci8?si=UrFdvuk_DIr3-h_0", handoutUrl: "" },
        { title: "å¯ä¸å¯ä»¥/æ“æŠ± æŒ‡æ³• åˆ·æ³•", desc: "ç¶œåˆç·´ç¿’ã€‚", videoUrl: "https://youtu.be/1QJCY_Y7FCQ?si=AlI_b7bjxDu0nS0U", handoutUrl: "" },
        { title: "æ…¢æ–æ»¾ç¯€å¥ æµªäººæƒ…æ­Œ", desc: "æ„Ÿå— Slow Rock çš„å¾‹å‹•ã€‚", videoUrl: "https://youtu.be/fpxQx3TeSGc?si=VtRA1apa1YATGBSX", handoutUrl: "" },
        { title: "æµªäººæƒ…æ­Œ æ–°ä¸äº†æƒ…", desc: "ç¶“å…¸æƒ…æ­Œå¯¦æˆ°ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å’Œå¼¦è¡¨3 è’²å…¬è‹±çš„ç´„å®š", desc: "å‘¨æ°å€«ç¶“å…¸æ›²ç›®ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ°‘è¬ æ–æ»¾ç¯€å¥ å°æ‰‹æ‹‰å¤§æ‰‹", desc: "è¼•å¿«çš„ Folk Rock ç¯€å¥ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æˆ€æ„›ING", desc: "å¿«é€Ÿåˆ·æ³•çš„ç·´ç¿’ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "åˆ†å‰²å’Œå¼¦/æ„›å¾ˆç°¡å–®", desc: "å­¸ç¿’ Slash Chords (å¦‚ C/G)ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å…’æ­Œ", desc: "ç°¡å–®å¥½è½çš„å…’æ­Œç·¨æ›²ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ„›å¾ˆç°¡å–®/å…’æ­Œ", desc: "ç¶œåˆç·´ç¿’ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ™´å¤©", desc: "å‘¨æ°å€«å¿…å­¸é‡‘æ›²ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ™´å¤©/è·‘é¦¬å¼ç¯€å¥", desc: "ç¨ç‰¹çš„ç¯€å¥å‹æ…‹ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "16beat/å¡è¾²", desc: "16åˆ†éŸ³ç¬¦çš„åˆ·æ³•æŒ‘æˆ°ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å¡è¾²/å°å¹¸é‹", desc: "æµè¡Œé‡‘æ›²å¯¦æˆ°ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ¨‚ç†/Gå¤§èª¿å’Œå¼¦/å°é–‰å’Œå¼¦Bm/æº«æŸ”", desc: "é€²å…¥å°é–‰å’Œå¼¦çš„å¤§é­”ç‹é—œå¡ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "ä½ çœ‹è‘—æˆ‘çš„çœ¼ç›èªª", desc: "æ­Œæ›²å¯¦æˆ°ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å‚å‹¾æ»‘éŸ³ç·´ç¿’/ä¸æ˜¯å¤©æ°£æ™´æœ—æ‰æ„›ä½ ", desc: "å‰ä»–è£é£¾éŸ³æŠ€å·§ (Hammer-on, Pull-off)ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "éˆé­‚æ¨‚/Kiss Me", desc: "Soul ç¯€å¥é¢¨æ ¼ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ ¹éŸ³èˆ‡ç¶“ééŸ³çš„è®ŠåŒ–/å¤©ä½¿", desc: "è®“ä¼´å¥æ›´è±å¯Œçš„æŠ€å·§ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "Wonderful Tonight", desc: "Clapton ç¶“å…¸ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "è½‰èª¿/Hey Jude", desc: "å­¸ç¿’æ­Œæ›²ä¸­é€”è½‰èª¿çš„æ¦‚å¿µã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ›å¼¦/æµ·ç¶¿å¯¶å¯¶", desc: "å‰ä»–ä¿é¤Šèˆ‡è¶£å‘³æ­Œæ›²ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å¤¢ä¸­çš„å©šç¦®", desc: "æ¼”å¥æ›²å…¥é–€ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ„›çš„ç¾…æ›¼å²", desc: "å¤å…¸å‰ä»–ç¶“å…¸åæ›²ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å¼·åŠ›å’Œçµƒ/è‡ªç”±", desc: "Power Chord èˆ‡æ–æ»¾æ¨‚ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "äº”è²éŸ³éš/è‡ªç”±solo", desc: "é€²å…¥å³èˆˆæ¼”å¥çš„å¤§é–€ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å¤ªé™½èˆ‡åœ°çƒ", desc: "æ¼”å¥æ›²ç·´ç¿’ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ€éº¼äº†æ¼”å¥æ›²", desc: "å‘¨èˆˆå“²æ­Œæ›²æ”¹ç·¨ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "ç´šæ•¸èˆ‡é †éšå’Œçµƒ/å¤§ä¸‰å°ä¸‰å’Œçµƒ", desc: "æ·±å…¥æ¨‚ç†çŸ¥è­˜ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å¡è¾²2/å°é–‰å’Œå¼¦", desc: "é€²éšå¡è¾²ç‰ˆæœ¬ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å’Œçµƒå‹•éŸ³ç·š/æ„›æˆ‘åˆ¥èµ°", desc: "Line Cliche æŠ€å·§ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ„›æˆ‘åˆ¥èµ°Solo/æƒ…æ­Œ", desc: "æ­Œæ›²ç¨å¥éƒ¨åˆ†ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ‰“ç‰ˆ/æ™®é€šæœ‹å‹", desc: "é™¶å–†ç¶“å…¸ï¼Œå­¸ç¿’æ‰“æ¿æŠ€å·§ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å’Œçµƒè£é£¾éŸ³/æ—…è¡Œçš„æ„ç¾©", desc: "é™³ç¶ºè²é¢¨æ ¼ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "é›™éŸ³/To Be With You", desc: "Double Stops æŠ€å·§ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "CAGEDç³»çµ±", desc: "æŒ‡æ¿é‚è¼¯ç³»çµ±ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "åˆ‡éŸ³èˆ‡æ‚¶éŸ³/I'm Yours", desc: "Jason Mraz çš„æ‹›ç‰Œç¯€å¥ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ³›éŸ³/æƒ³è¦‹ä½ ", desc: "Harmonics æŠ€å·§ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "ç°¡åŒ–å’Œçµƒ/é‚„æ˜¯æœƒ", desc: "è¤‡é›œå’Œå¼¦çš„ç°¡åŒ–æŒ‰æ³•ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ”¾å…‹", desc: "Funk é¢¨æ ¼ç¯€å¥ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å’Œçµƒçš„é€£æ¥èˆ‡ç¶“éå’Œçµƒ/é«”é¢", desc: "è®“å’Œå¼¦é€²è¡Œæ›´é †æš¢ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ„›çš„ç¾…æ›¼å²2", desc: "é€²éšç‰ˆæœ¬ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å¤§ä¸ƒå°ä¸ƒå±¬ä¸ƒå’Œå¼¦", desc: "7th Chords çš„è‰²å½©ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "ä»£ç†å’Œçµƒ/ä¿®ç·´æ„›æƒ…", desc: "å’Œå¼¦æ›¿ä»£çš„æ¦‚å¿µã€‚", videoUrl: "", handoutUrl: "" },
        { title: "é›™å‰ä»–ä¼´å¥ç·¨æ›²", desc: "å¦‚ä½•èˆ‡å¦ä¸€æŠŠå‰ä»–é…åˆã€‚", videoUrl: "", handoutUrl: "" },
        { title: "è—èª¿éŸ³éš/è—èª¿12å°ç¯€", desc: "Blues åŸºç¤ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æŒ‡æ¿è‡ªç„¶éŸ³éš 5æŒ‡å‹", desc: "ç†Ÿæ‚‰æ•´å€‹æŒ‡æ¿ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "è—èª¿ç¯„ä¾‹å¥å‹", desc: "Blues Licksã€‚", videoUrl: "", handoutUrl: "" },
        { title: "å³èˆˆå¯¦æˆ° (Call & Response)", desc: "å°è©±å¼çš„å³èˆˆã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æ¼”å¥æ›² å²¸éƒ¨çœŸæ˜-èŠ±", desc: "æŒ‡å½ˆå¤§å¸«åæ›²ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "Shell VoicingæŠ€å·§", desc: "è®“å’Œå¼¦æ›´åŠ å¤šæ¨£åŒ–ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "Bossa Nova ç¯€å¥èˆ‡å’Œå¼¦", desc: "çˆµå£«å…¥é–€é¢¨æ ¼ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "è½éŸ³è¨“ç·´èˆ‡æŠ“æ­ŒæŠ€å·§", desc: "è¨“ç·´è€³æœµã€‚", videoUrl: "", handoutUrl: "" },
        { title: "éŒ„éŸ³ä»‹é¢èˆ‡ç°¡æ˜“å®…éŒ„", desc: "éŒ„éŸ³ä»‹é¢ä»‹ç´¹å°‡è‡ªå·±çš„å‰µä½œé«˜å“è³ªéŒ„è£½ã€‚", videoUrl: "", handoutUrl: "" },
        { title: "æˆæœç™¼è¡¨ / ç¸½è¤‡ç¿’", desc: "60é€±èª²ç¨‹ç¸½çµèˆ‡æœªä¾†å±•æœ›ã€‚", videoUrl: "", handoutUrl: "" }
    ];

    // é è¨­å’Œå¼¦ (å¯ä»¥è¢« LocalStorage è¦†è“‹)
    const DEFAULT_CHORDS = {
        'C': [{s:5,f:3,finger:3,isRoot:true}, {s:4,f:2,finger:2}, {s:2,f:1,finger:1}],
        'D': [{s:4,f:0,finger:0,isRoot:true}, {s:3,f:2,finger:1}, {s:1,f:2,finger:2}, {s:2,f:3,finger:3}],
        'E': [{s:6,f:0,finger:0,isRoot:true}, {s:3,f:1,finger:1}, {s:5,f:2,finger:2}, {s:4,f:2,finger:3}],
        'G': [{s:6,f:3,finger:2,isRoot:true}, {s:5,f:2,finger:1}, {s:1,f:3,finger:3}],
        'A': [{s:5,f:0,finger:0,isRoot:true}, {s:4,f:2,finger:1}, {s:3,f:2,finger:2}, {s:2,f:2,finger:3}],
        'Am': [{s:5,f:0,finger:0,isRoot:true}, {s:2,f:1,finger:1}, {s:4,f:2,finger:2}, {s:3,f:2,finger:3}],
        'Em': [{s:6,f:0,finger:0,isRoot:true}, {s:5,f:2,finger:2}, {s:4,f:2,finger:3}]
    };

    createApp({
        data() {
            return {
                loginForm: { username: '', password: '' },
                user: { isLoggedIn: false, role: '', xp: 0, badges: [] },
                lessons: [],
                credentials: { teacher: {username: 'admin', password: '1234'}, student: {username: 'student', password: '1234'} },
                settings: { logoUrl: './logo.png' },
                currentLessonIndex: 0,
                newComment: '',
                tempHomework: { link: '', note: '' },
                showMetronome: false,
                metronome: { bpm: 80, isPlaying: false, currentBeat: 0, timer: null, ctx: null },
                
                // å’Œå¼¦ç›¸é—œ
                showChordModal: false,
                isEditingChord: false, // æ˜¯å¦æ­£åœ¨ç·¨è¼¯
                customChords: {}, // å­˜å„²è€å¸«è‡ªè¨‚çš„å’Œå¼¦
                chord: { root: 'C', suffix: '' },
                chordRoots: ['C','D','E','F','G','A','B'],
                chordSuffixes: [{val:'',name:'Major'}, {val:'m',name:'minor'}, {val:'7',name:'7'}],
                badges: BADGES
            }
        },
        computed: {
            currentLesson() {
                const l = this.lessons[this.currentLessonIndex];
                if(l && !l.homework) l.homework = { hasSubmission: false };
                return l || {};
            },
            userLevel() {
                const level = Math.floor(this.user.xp / 100) + 1;
                const progress = this.user.xp % 100;
                return { level, progress, nextLevelXp: level * 100 + 100 };
            },
            currentChordDots() {
                const key = this.chord.root + this.chord.suffix;
                // å„ªå…ˆä½¿ç”¨è‡ªè¨‚ï¼Œæ²’æœ‰å‰‡ç”¨é è¨­ï¼Œå†æ²’æœ‰å‰‡å›å‚³ç©º
                return this.customChords[key] || DEFAULT_CHORDS[key] || [];
            }
        },
        mounted() {
            const savedData = localStorage.getItem('frankGuitar_v9_data');
            
            // 1. åˆå§‹åŒ–èª²ç¨‹
            this.lessons = lessonsData.map(l => ({
                ...l,
                comments: [],
                homework: { hasSubmission: false, link: "", note: "", date: "", isGraded: false, teacherGrade: "", teacherFeedback: "" },
                isViewed: false
            }));

            // 2. è¼‰å…¥å­˜æª”
            if(savedData) {
                const parsed = JSON.parse(savedData);
                this.user.xp = parsed.xp || 0;
                this.user.badges = parsed.badges || [];
                // è¼‰å…¥è‡ªè¨‚å’Œå¼¦
                this.customChords = parsed.customChords || {}; 
                
                if(parsed.userLessonsProgress) {
                    parsed.userLessonsProgress.forEach((p, i) => {
                        if(this.lessons[i]) {
                            this.lessons[i].isViewed = p.isViewed;
                            this.lessons[i].homework = p.homework;
                            this.lessons[i].comments = p.comments;
                        }
                    });
                }
            } else {
                // å¦‚æœæ²’æœ‰å­˜æª”ï¼Œåˆå§‹åŒ– customChords ç‚ºç©º (æœƒè‡ªå‹•ç”¨é è¨­)
                this.customChords = {};
            }
        },
        methods: {
            handleLogin() {
                const { username, password } = this.loginForm;
                if (username === this.credentials.teacher.username && password === this.credentials.teacher.password) {
                    this.user = { ...this.user, isLoggedIn: true, role: 'teacher' };
                } else if (username === this.credentials.student.username && password === this.credentials.student.password) {
                    this.user = { ...this.user, isLoggedIn: true, role: 'student' };
                } else {
                    alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼');
                }
            },
            logout() {
                this.user.isLoggedIn = false;
                this.loginForm = { username: '', password: '' };
                this.stopMetronome();
            },
            saveData() {
                const userLessonsProgress = this.lessons.map(l => ({
                    isViewed: l.isViewed,
                    homework: l.homework,
                    comments: l.comments
                }));
                const dataToSave = {
                    xp: this.user.xp,
                    badges: this.user.badges,
                    userLessonsProgress: userLessonsProgress,
                    customChords: this.customChords // å„²å­˜è€å¸«ç·¨è¼¯çš„å’Œå¼¦
                };
                localStorage.setItem('frankGuitar_v9_data', JSON.stringify(dataToSave));
                this.checkBadges();
            },
            
            // --- å’Œå¼¦ç·¨è¼¯åŠŸèƒ½ ---
            toggleChordEdit() {
                this.isEditingChord = !this.isEditingChord;
                if(!this.isEditingChord) {
                    this.saveData(); // é—œé–‰ç·¨è¼¯æ™‚å­˜æª”
                    alert('å’Œå¼¦è¨­å®šå·²å„²å­˜ (æœ¬åœ°)ï¼');
                }
            },
            handleFretClick(string, fret) {
                if (!this.isEditingChord) return;
                
                const key = this.chord.root + this.chord.suffix;
                // å¦‚æœè©²å’Œå¼¦é‚„æ²’è‡ªè¨‚éï¼Œå…ˆè¤‡è£½é è¨­å€¼
                if (!this.customChords[key]) {
                    this.customChords[key] = JSON.parse(JSON.stringify(DEFAULT_CHORDS[key] || []));
                }
                
                const dots = this.customChords[key];
                const existingIndex = dots.findIndex(d => d.s === string && d.f === fret);
                
                if (existingIndex !== -1) {
                    // å·²å­˜åœ¨ï¼šå¾ªç’°æŒ‡æ³• 1->2->3->4->ç§»é™¤
                    if (dots[existingIndex].finger < 4) {
                        dots[existingIndex].finger++;
                    } else {
                        dots.splice(existingIndex, 1);
                    }
                } else {
                    // ä¸å­˜åœ¨ï¼šæ–°å¢ (é è¨­æŒ‡æ³•1)
                    dots.push({ s: string, f: fret, finger: 1, isRoot: false });
                }
            },
            handleFretRightClick(string, fret) {
                if (!this.isEditingChord) return;
                const key = this.chord.root + this.chord.suffix;
                if (!this.customChords[key]) {
                    this.customChords[key] = JSON.parse(JSON.stringify(DEFAULT_CHORDS[key] || []));
                }
                const dots = this.customChords[key];
                const dot = dots.find(d => d.s === string && d.f === fret);
                if (dot) {
                    dot.isRoot = !dot.isRoot; // åˆ‡æ›æ ¹éŸ³ç‹€æ…‹
                }
            },

            // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸è®Š (selectLesson, submitHomework, Metronome etc.) ...
            selectLesson(index) {
                this.currentLessonIndex = index;
                this.tempHomework = { link: '', note: '' };
                if(!this.lessons[index].isViewed && this.user.role === 'student') {
                    this.lessons[index].isViewed = true;
                    this.addXp(10);
                }
            },
            addXp(amount) { this.user.xp += amount; this.saveData(); },
            checkBadges() {
                const viewedCount = this.lessons.filter(l => l.isViewed).length;
                const hwCount = this.lessons.filter(l => l.homework && l.homework.hasSubmission).length;
                const award = (id) => { if(!this.user.badges.includes(id)) { this.user.badges.push(id); alert(`ğŸ‰ å¾½ç« ç²å¾—ï¼š${BADGES.find(b=>b.id===id).name}`); } }
                if(viewedCount >= 5) award('novice'); if(hwCount >= 5) award('homework_king');
                if(viewedCount >= 30) award('halfway'); if(viewedCount >= 60) award('master');
            },
            submitHomework() {
                if(!this.tempHomework.link) return alert('è«‹è¼¸å…¥é€£çµ');
                const now = new Date();
                this.currentLesson.homework = { hasSubmission: true, link: this.tempHomework.link, note: this.tempHomework.note, date: `${now.getMonth()+1}/${now.getDate()}`, isGraded: false };
                this.addXp(50); alert('ä½œæ¥­å·²æäº¤ï¼');
            },
            saveHomeworkGrade() { this.currentLesson.homework.isGraded = true; this.saveData(); alert('è©•åˆ†å·²é€å‡º'); },
            addComment() {
                if(!this.newComment.trim()) return;
                const now = new Date();
                this.currentLesson.comments.push({ user: this.user.role === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ', role: this.user.role, text: this.newComment, time: `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}` });
                this.newComment = ''; this.saveData();
            },
            toggleMetronome() { this.metronome.isPlaying ? this.stopMetronome() : this.startMetronome(); },
            startMetronome() {
                if(!this.metronome.ctx) this.metronome.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.metronome.isPlaying = true;
                let nextTime = this.metronome.ctx.currentTime;
                const schedule = () => { if(!this.metronome.isPlaying) return; while(nextTime < this.metronome.ctx.currentTime + 0.1) { this.playClick(nextTime); this.metronome.currentBeat = (this.metronome.currentBeat % 4) + 1; nextTime += 60.0 / this.metronome.bpm; } this.metronome.timer = requestAnimationFrame(schedule); };
                schedule();
            },
            stopMetronome() { this.metronome.isPlaying = false; cancelAnimationFrame(this.metronome.timer); this.metronome.currentBeat = 0; },
            playClick(time) { const osc = this.metronome.ctx.createOscillator(); const gain = this.metronome.ctx.createGain(); osc.connect(gain); gain.connect(this.metronome.ctx.destination); osc.frequency.value = (this.metronome.currentBeat === 4) ? 1000 : 800; osc.start(time); osc.stop(time + 0.05); },
            adjustBpm(val) { this.metronome.bpm = Math.max(40, Math.min(240, this.metronome.bpm + val)); },
            getEmbedUrl(url) { if (!url) return null; try { const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/; const match = url.match(regex); return match && match[1] ? `https://www.youtube.com/embed/${match[1]}?rel=0` : null; } catch(e) { return null; } },
            isImage(url) { return url && url.match(/\.(jpeg|jpg|gif|png|webp)$/i) != null; }
        }
    }).mount('#app');
</script>
</body>
</html>